name: ccache-restore
description: Restore ccache data from GHCR via ORAS

inputs:
  cache-key:
    description: 'Tag prefix for the ccache artifact, e.g. arm64-build, amd64-devenv'
    required: true
  output-path:
    description: 'Directory to extract ccache data into'
    required: false
    default: '/tmp/ccache-data'
  registry-token:
    description: 'GitHub token for GHCR authentication'
    required: true
  pr-number:
    description: 'PR number for tag lookup. Auto-detected from ref_name when empty.'
    required: false
    default: ''
  base-branch:
    description: 'Base branch to fall back to. Auto-detected from PR target when empty.'
    required: false
    default: ''

outputs:
  restored:
    description: 'Whether a ccache artifact was successfully restored'
    value: ${{ steps.restore.outputs.restored }}

runs:
  using: "composite"
  steps:
    - name: Restore ccache from GHCR
      id: restore
      continue-on-error: true
      shell: bash
      run: |
        repo_owner=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        platform=$([ "$(uname)" = "Darwin" ] && echo macos || echo linux)
        image="ghcr.io/${repo_owner}/cuda-quantum-${platform}-ccache"
        cache_key="${{ inputs.cache-key }}"

        # Auto-detect PR number from ref name if not provided
        pr_number="${{ inputs.pr-number }}"
        if [ -z "$pr_number" ]; then
          pr_number=$(echo "${{ github.ref_name }}" | grep pull-request/ | grep -o '[0-9]*' || true)
          pr_number=${pr_number:-${{ github.event.pull_request.number }}}
        fi

        # Auto-detect base branch from PR if not provided
        base_branch="${{ inputs.base-branch }}"
        if [ -z "$base_branch" ] && [ -n "$pr_number" ]; then
          export GH_TOKEN="${{ inputs.registry-token }}"
          base_branch=$(gh pr view "$pr_number" -R "${{ github.repository }}" \
            --json baseRefName --jq .baseRefName 2>/dev/null || true)
        fi
        base_branch="${base_branch:-main}"

        echo "${{ inputs.registry-token }}" | oras login ghcr.io -u ${{ github.actor }} --password-stdin

        mkdir -p "${{ inputs.output-path }}"

        # Try tags in priority order: PR-specific cache first (most relevant),
        # then the PR's target branch (e.g. releases/0.9), then main as
        # final fallback.
        tags=()
        if [ -n "$pr_number" ]; then
          tags+=("${cache_key}-pr-${pr_number}")
        fi
        if [ -n "$base_branch" ] && [ "$base_branch" != "main" ]; then
          tags+=("${cache_key}-${base_branch}")
        fi
        tags+=("${cache_key}-main")

        restored=false
        for tag in "${tags[@]}"; do
          echo "Trying $image:$tag ..."
          if oras pull "$image:$tag" 2>/dev/null; then
            echo "Downloaded ccache tarball: $(du -sh ccache-data.tar.gz | cut -f1)"
            tar -xzf ccache-data.tar.gz -C "${{ inputs.output-path }}"
            rm -f ccache-data.tar.gz
            echo "Restored ccache from $image:$tag (extracted: $(du -sh "${{ inputs.output-path }}" | cut -f1))"
            restored=true
            break
          fi
        done

        if ! $restored; then
          echo "No ccache found; starting fresh."
        fi
        echo "restored=$restored" >> $GITHUB_OUTPUT
