on:
  workflow_dispatch:
    inputs:
      version:
        required: true
        type: string
        description: 'The version that the documentation corresponds to.'
      download_url:
        required: true
        type: string
        description: 'The url from which to download the built documentation.'
  workflow_run:
    workflows:
      - CI
      - Deployments
    types:
      - completed

name: Docs publishing

concurrency:
    group: ${{ github.workflow }}
    cancel-in-progress: false

jobs:
  publish_docs:
    name: Publish documentation in a subfolder
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
  
    environment:
      name: github-pages
      url: 'https://nvidia.github.io/cuda-quantum/preview'
  
    steps:
      - name: Download docs artifact
        id: artifacts
        run: |
          target_folder=`echo ${{ github.event.workflow_run.head_branch }} | tr / -`
          actor=${{ github.event.workflow_run.actor }}
          triggering_actor=${{ github.event.workflow_run.triggering_actor }}

          # FIXME
          #artifacts_url=${{ github.event.workflow_run.artifacts_url }}
          artifacts_url='https://api.github.com/repos/bettinaheim/cuda-quantum/actions/runs/5004485352/artifacts'
          artifacts=$(gh api $artifacts_url -q '.artifacts[] | {name: .name, url: .archive_download_url}')

          status=1
          for artifact in `echo "$artifacts"`; do
            name=`echo $artifact | jq -r '.name'`
            if [ "$name" == "cuda_quantum_docs" ]; then
              url=`echo $artifact | jq -r '.url'`
              gh api $url > cuda_quantum_docs.zip
              rm -rf ${{ github.inputs.version }}
              unzip -d ${{ github.inputs.version }} cuda_quantum_docs.zip # FIXME
              rm -rf cuda_quantum_docs.zip
              status=0
            fi
          done
          exit $status
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Setup Pages
        uses: actions/configure-pages@v2
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v1
        with:
          name: docs_pages
          path: .
          retention-days: 1
        
      - name: Deploy docs
        id: docs_deployment
        uses: actions/deploy-pages@v2
        with:
          artifact_name: docs_pages
        
