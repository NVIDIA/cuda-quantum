on:
  workflow_run:
    workflows:
      - Packages
    types:
      - completed

name: Docs preview

concurrency:
    group: ${{ github.workflow }}-${{ github.event.workflow_run.head_branch }}
    cancel-in-progress: false

jobs:
  publish_docs:
    name: Publish documentation in a subfolder
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      # pages: write
      # id-token: write
  
    environment:
      name: github-pages
      url: 'https://nvidia.github.io/cuda-quantum/preview'
  
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: 'gh-pages'

      - name: Download docs artifact
        id: artifacts
        run: |
          target_folder=`echo ${{ github.event.workflow_run.head_branch }} | | tr / -`
          actor=${{ github.event.workflow_run.actor.name }}
          triggering_actor=${{ github.event.workflow_run.triggering_actor.name }}

          artifacts_url=${{ github.event.workflow_run.artifacts_url }}
          artifacts=$(gh api $artifacts_url -q '.artifacts[] | {name: .name, url: .archive_download_url}')

          for artifact in `echo "$artifacts"`; do
            name=`echo $artifact | jq -r '.name'`
            if [ "$name" == "cuda_quantum_docs" ]; then
              url=`echo $artifact | jq -r '.url'`
              gh api $url > cuda_quantum_docs.zip
              unzip -d "$target_folder" cuda_quantum_docs.zip # FIXME

              git config --global user.name "Docs Bot"
              git config --global user.email "${{ github.event.workflow_run.actor.email }}"  # "${actor}@users.noreply.github.com"
              git add "$target_folder"
              git commit -m "Documentation generated by commit ${{ github.event.workflow_run.head_sha }}"
              # git push

              rm -rf preview cuda_quantum_docs.zip
            fi
          done
        env:
          GH_TOKEN: ${{ github.token }}
