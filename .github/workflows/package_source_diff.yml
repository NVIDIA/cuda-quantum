# ============================================================================ #
# Copyright (c) 2022 - 2026 NVIDIA Corporation & Affiliates.                   #
# All rights reserved.                                                         #
#                                                                              #
# This source code and the accompanying materials are made available under     #
# the terms of the Apache License 2.0 which accompanies this distribution.     #
# ============================================================================ #
#
# Workflow: diff apt and pip packages between a base and target image, then
# build an Ubuntu 24.04 image containing source code for all added packages.
#
# The target image is assumed to be built FROM the base image. This workflow
# computes the set of apt and pip packages present in the target but not in
# the base, then produces a new image (based on ubuntu:24.04) that contains
# the source code for those packages under /sources (apt under /sources/apt,
# pip sdists under /sources/pip, and repo tpls/ under /sources/tpls).

on:
  push:
  workflow_dispatch:
    inputs:
      base_image:
        required: true
        type: string
        description: 'Base image (target is built from this).'
      target_image:
        required: true
        type: string
        description: 'Target image (contains base + additional packages).'
      push_image:
        required: false
        type: boolean
        default: true
        description: 'Push the built source image to GHCR (requires permissions).'
      environment:
        required: false
        type: string

name: Package source diff

jobs:
  diff-packages:
    name: Diff apt/pip packages
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Log in to container registries
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin 2>/dev/null || true
          echo "${{ secrets.DOCKERHUB_READONLY_TOKEN }}" | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin 2>/dev/null || true

      - name: Pull images
        run: |
          docker pull "${{ inputs.base_image || 'nvcr.io/nvidia/cuda:13.0.0-runtime-ubuntu24.04' }}"
          docker pull "${{ inputs.target_image || 'nvcr.io/nvidia/nightly/cuda-quantum:cu13-latest' }}"

      - name: Diff package lists
        run: |
          chmod +x scripts/diff_image_packages.sh
          ./scripts/diff_image_packages.sh \
            "${{ inputs.base_image || 'nvcr.io/nvidia/cuda:13.0.0-runtime-ubuntu24.04' }}" \
            "${{ inputs.target_image || 'nvcr.io/nvidia/nightly/cuda-quantum:cu13-latest' }}" \
            package-source-diff

      - name: Upload package lists
        uses: actions/upload-artifact@v4
        with:
          name: package-source-diff
          path: package-source-diff/
          retention-days: 1

  build-source-image:
    name: Build Ubuntu 24.04 source image
    needs: diff-packages
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          persist-credentials: false
          submodules: recursive

      - name: Download package lists
        uses: actions/download-artifact@v4
        with:
          name: package-source-diff

      - name: Restore package-source-diff directory layout
        run: |
          # Ensure package-source-diff/ exists with list files for Dockerfile COPY
          if [ ! -f package-source-diff/apt_packages.txt ]; then
            mkdir -p package-source-diff
            mv apt_packages.txt pip_packages.txt package-source-diff/ 2>/dev/null || true
          fi
          touch package-source-diff/apt_packages.txt package-source-diff/pip_packages.txt
          ls -la package-source-diff/

      - name: Generate tpls lock file
        run: |
          chmod +x scripts/generate_tpls_lock.sh
          ./scripts/generate_tpls_lock.sh tpls_commits.lock
          wc -l tpls_commits.lock || true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build source image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/build/package_sources.Dockerfile
          load: true
          tags: package-sources:latest
          outputs: type=docker,dest=/tmp/package-sources.tar
          push: false

      - name: Log in to GitHub CR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Tag and push to GHCR
        if: inputs.push_image
        id: push
        run: |
          docker load --input /tmp/package-sources.tar
          target_image="${{ inputs.target_image || 'nvcr.io/nvidia/nightly/cuda-quantum:cu13-latest' }}"
          tag_suffix="${target_image##*:}"
          tag="ghcr.io/${{ github.repository_owner }}/cuda-quantum-src:${tag_suffix}"
          docker tag package-sources:latest "$tag"
          docker push "$tag"
          echo "image_tag=$tag" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "## Package source diff" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Base image:** \`${{ inputs.base_image || 'nvcr.io/nvidia/cuda:13.0.0-runtime-ubuntu24.04' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Target image:** \`${{ inputs.target_image || 'nvcr.io/nvidia/nightly/cuda-quantum:cu13-latest' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Apt packages added:** $(wc -l < package-source-diff/apt_packages.txt 2>/dev/null || echo 0)" >> $GITHUB_STEP_SUMMARY
          echo "- **Pip packages added:** $(wc -l < package-source-diff/pip_packages.txt 2>/dev/null || echo 0)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Built image \`package-sources:latest\` (ubuntu:24.04 with sources under \`/sources/apt\`, \`/sources/pip\`, and \`/sources/tpls\`)." >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.push_image }}" = "true" ] && [ -n "${{ steps.push.outputs.image_tag }}" ]; then
            echo "- **Pushed:** \`${{ steps.push.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          fi
