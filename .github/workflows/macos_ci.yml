name: macOS CI

on:
  workflow_dispatch:

jobs:
  # ============================================================================
  # Metadata: Get commit hashes for cache keys
  # ============================================================================
  metadata:
    name: Metadata
    runs-on: ubuntu-latest
    outputs:
      llvm_commit: ${{ steps.repo_info.outputs.llvm_commit }}
      pybind11_commit: ${{ steps.repo_info.outputs.pybind11_commit }}
    steps:
      - uses: actions/checkout@v4
      - id: repo_info
        run: |
          echo "llvm_commit=$(git rev-parse @:./tpls/llvm)" >> $GITHUB_OUTPUT
          echo "pybind11_commit=$(git rev-parse @:./tpls/pybind11)" >> $GITHUB_OUTPUT

  # ============================================================================
  # Build prerequisites (LLVM, OpenMP, etc.) WITHOUT Python bindings
  # Python bindings are rebuilt per-Python-version in build_and_test/wheel jobs
  # This mirrors the Linux CI architecture (wheeldeps â†’ python_wheels)
  # ============================================================================
  devdeps:
    name: Prerequisites (${{ matrix.runner }})
    needs: metadata
    strategy:
      matrix:
        include:
          - runner: macos-15-arm64
            arch: arm64
            deployment_target: '11.0'  # macOS Big Sur (first ARM64)
          - runner: macos-26
            arch: arm64
            deployment_target: '11.0'  # macOS Big Sur (first ARM64)
          - runner: macos-15
            arch: x86_64
            deployment_target: '10.15'  # macOS Catalina (x86_64)
      fail-fast: false
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4
        # Note: submodules not needed for this stage - LLVM is cloned to ~/.llvm-project by build script

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: System info
        run: |
          echo "=== System ===" 
          uname -a
          sw_vers
          echo "=== Hardware ==="
          sysctl hw.ncpu hw.memsize
          df -h
          echo "=== Toolchain ==="
          clang --version
          python3 --version
          cmake --version
          brew --version

      - name: Cache prerequisites
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.local
            ~/.llvm-project
          # Cache: installed libs (~/.local) + LLVM source/build (~/.llvm-project)
          # Source+build needed for incremental Python bindings rebuild in wheel job
          key: ${{ matrix.runner }}-${{ matrix.deployment_target }}-devdeps-v3-${{ needs.metadata.outputs.llvm_commit }}

      - name: Build prerequisites
        if: steps.cache.outputs.cache-hit != 'true'
        env:
          MACOSX_DEPLOYMENT_TARGET: ${{ matrix.deployment_target }}
        run: |
          # Fix CI runner quirk: gcc pre-installed but not linked
          brew unlink gcc 2>/dev/null || true
          brew link gcc --overwrite 2>/dev/null || true
          which gfortran || { echo "ERROR: gfortran not found!"; exit 1; }
          
          # Override LLVM_PROJECTS to exclude python-bindings
          # Python bindings will be rebuilt per-Python-version in wheel job
          export LLVM_PROJECTS='clang;lld;mlir;openmp'
          
          echo "MACOSX_DEPLOYMENT_TARGET=$MACOSX_DEPLOYMENT_TARGET"
          source scripts/set_env_defaults.sh
          echo "=== Build Configuration ==="
          echo "LLVM_INSTALL_PREFIX=$LLVM_INSTALL_PREFIX"
          echo "LLVM_PROJECTS=$LLVM_PROJECTS"
          echo "Building with $(sysctl -n hw.ncpu) cores, $(( $(sysctl -n hw.memsize) / 1024 / 1024 / 1024 )) GB RAM"
          
          bash scripts/install_prerequisites.sh

      - name: Verify installation
        run: |
          source scripts/set_env_defaults.sh
          echo "=== LLVM Installation ==="
          ls -la $LLVM_INSTALL_PREFIX/bin/ | head -20
          $LLVM_INSTALL_PREFIX/bin/clang --version
          echo "=== OpenMP Check ==="
          ls -la $LLVM_INSTALL_PREFIX/lib/libomp* 2>/dev/null || echo "OpenMP libraries not found"
          echo "=== LLVM Source + Build ==="
          ls -la ~/.llvm-project/ 2>/dev/null | head -5 || echo "LLVM project not found"
          echo "=== Cache sizes ==="
          du -sh ~/.local || true
          du -sh ~/.llvm-project || true

  # ============================================================================
  # Build and test CUDA-Q
  # ============================================================================
  build_and_test:
    name: Build (${{ matrix.runner }}${{ matrix.name_suffix }})
    needs: [metadata, devdeps]
    strategy:
      matrix:
        include:
          - runner: macos-15-arm64
            arch: arm64
            deployment_target: '11.0'
          - runner: macos-26
            arch: arm64
            deployment_target: '11.0'
          - runner: macos-26
            arch: arm64
            deployment_target: ''  # Native - no override, use host default
            name_suffix: '-native'
          - runner: macos-15
            arch: x86_64
            deployment_target: '10.15'
      fail-fast: false
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Restore prerequisites cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.local
            ~/.llvm-project
          # Native builds reuse the 11.0 devdeps cache (devdeps don't depend on deployment target)
          key: ${{ matrix.runner }}-${{ matrix.deployment_target || '11.0' }}-devdeps-v3-${{ needs.metadata.outputs.llvm_commit }}
          fail-on-cache-miss: true

      - name: Install Python dependencies
        run: pip install -r requirements-dev.txt

      - name: Build MLIR Python bindings
        run: |
          source scripts/set_env_defaults.sh
          
          # Incremental rebuild: add python-bindings to cached LLVM build
          Python3_EXECUTABLE="$(which python3)" \
          LLVM_PROJECTS='clang;lld;mlir;openmp;python-bindings' \
          LLVM_SOURCE="$HOME/.llvm-project" \
          bash scripts/build_llvm.sh -c Release -v

      - name: Build CUDA-Q
        run: |
          # Only set deployment target if specified (empty = use native/default)
          if [ -n "${{ matrix.deployment_target }}" ]; then
            export MACOSX_DEPLOYMENT_TARGET="${{ matrix.deployment_target }}"
            echo "Using MACOSX_DEPLOYMENT_TARGET=$MACOSX_DEPLOYMENT_TARGET"
          else
            echo "Using native deployment target (no override)"
          fi
          bash scripts/build_cudaq.sh -v

      - name: Debug environment
        run: |
          echo "=== Environment ==="
          env | sort
          echo "=== DYLD paths ==="
          echo "DYLD_LIBRARY_PATH=${DYLD_LIBRARY_PATH:-not set}"
          echo "DYLD_FALLBACK_LIBRARY_PATH=${DYLD_FALLBACK_LIBRARY_PATH:-not set}"
          echo "=== Linker version ==="
          ld -v 2>&1 || true
          echo "=== LLVM install ==="
          ls -la ~/.local/llvm/lib/*.dylib 2>/dev/null | head -20 || echo "No dylibs found"
          echo "=== Build libs ==="
          ls -la build/lib/*.dylib 2>/dev/null | head -20 || echo "No build dylibs"
          
      - name: Debug single test
        run: |
          source scripts/set_env_defaults.sh
          echo "=== Running single BuilderTester test with debug ==="
          cd build
          # Enable CUDAQ debug logging
          export CUDAQ_LOG_LEVEL=info
          # Run single test to see crash details
          ctest -V -R "qpp_BuilderTester.checkSimple" --timeout 60 || true
          echo "=== Test exit code: $? ==="
          
      - name: Check crash reports
        if: always()
        run: |
          echo "=== Recent crash reports ==="
          ls -la ~/Library/Logs/DiagnosticReports/*.crash 2>/dev/null | tail -10 || echo "No crash reports"
          # Show most recent crash report if exists
          latest=$(ls -t ~/Library/Logs/DiagnosticReports/*.crash 2>/dev/null | head -1)
          if [ -n "$latest" ]; then
            echo "=== Latest crash report: $latest ==="
            head -200 "$latest"
          fi

      - name: Run tests
        run: bash scripts/run_tests.sh -v
