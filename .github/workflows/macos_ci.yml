name: macOS CI

on:
  workflow_dispatch:

jobs:
  # ============================================================================
  # Metadata: Get commit hashes for cache keys
  # ============================================================================
  metadata:
    name: Metadata
    runs-on: ubuntu-latest
    outputs:
      llvm_commit: ${{ steps.repo_info.outputs.llvm_commit }}
      pybind11_commit: ${{ steps.repo_info.outputs.pybind11_commit }}
    steps:
      - uses: actions/checkout@v4
      - id: repo_info
        run: |
          echo "llvm_commit=$(git rev-parse @:./tpls/llvm)" >> $GITHUB_OUTPUT
          echo "pybind11_commit=$(git rev-parse @:./tpls/pybind11)" >> $GITHUB_OUTPUT

  # ============================================================================
  # Build prerequisites (LLVM, OpenMP, etc.) - WITHOUT Python bindings
  # Python bindings will be rebuilt per-Python-version in wheel job
  # ============================================================================
  devdeps:
    name: Prerequisites (${{ matrix.arch }})
    needs: metadata
    strategy:
      matrix:
        include:
          - runner: macos-15
            arch: arm64
            deployment_target: '11.0'  # macOS Big Sur (first ARM64)
          # Uncomment to enable Intel x86_64. Should we provide official x86 support?
          # All current hardware is Apple silicon and Github is deprecating x86 runners in August 2027.
          # - runner: macos-15-intel  # Intel runner (available until Aug 2027)
          #   arch: x86_64
          #   deployment_target: '10.13' # macOS High Sierra (required by Python 3.12+)
      fail-fast: false
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 360
    steps:
      - uses: actions/checkout@v4
        # Note: submodules not needed for this stage - LLVM is cloned to ~/.llvm-project by build script

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: System info
        run: |
          echo "=== System ===" 
          uname -a
          sw_vers
          echo "=== Hardware ==="
          sysctl hw.ncpu hw.memsize
          df -h
          echo "=== Toolchain ==="
          clang --version
          python3 --version
          cmake --version
          brew --version

      - name: Cache prerequisites
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.local
            ~/.llvm-project
          # Cache: installed libs (~/.local) + LLVM source/build (~/.llvm-project)
          # Source+build needed for incremental Python bindings rebuild in wheel job
          key: macos-${{ matrix.arch }}-${{ matrix.deployment_target }}-devdeps-${{ needs.metadata.outputs.llvm_commit }}

      - name: Build prerequisites
        if: steps.cache.outputs.cache-hit != 'true'
        env:
          MACOSX_DEPLOYMENT_TARGET: ${{ matrix.deployment_target }}
        run: |
          # Fix CI runner quirk: gcc pre-installed but not linked
          brew unlink gcc 2>/dev/null || true
          brew link gcc --overwrite 2>/dev/null || true
          which gfortran || { echo "ERROR: gfortran not found!"; exit 1; }
          
          # Install LLD for faster linking
          brew install lld
          
          # Override LLVM_PROJECTS to exclude python-bindings
          # Python bindings will be rebuilt per-Python-version in wheel job
          export LLVM_PROJECTS='clang;lld;mlir;openmp'
          
          echo "MACOSX_DEPLOYMENT_TARGET=$MACOSX_DEPLOYMENT_TARGET"
          source scripts/set_env_defaults.sh
          echo "=== Build Configuration ==="
          echo "LLVM_INSTALL_PREFIX=$LLVM_INSTALL_PREFIX"
          echo "LLVM_PROJECTS=$LLVM_PROJECTS"
          echo "Building with $(sysctl -n hw.ncpu) cores, $(( $(sysctl -n hw.memsize) / 1024 / 1024 / 1024 )) GB RAM"
          
          bash scripts/install_prerequisites.sh

      - name: Verify installation
        run: |
          source scripts/set_env_defaults.sh
          echo "=== LLVM Installation ==="
          ls -la $LLVM_INSTALL_PREFIX/bin/ | head -20
          $LLVM_INSTALL_PREFIX/bin/clang --version
          echo "=== OpenMP Check ==="
          ls -la $LLVM_INSTALL_PREFIX/lib/libomp* 2>/dev/null || echo "OpenMP libraries not found"
          echo "=== LLVM Source + Build ==="
          ls -la ~/.llvm-project/ 2>/dev/null | head -5 || echo "LLVM project not found"
          echo "=== Cache sizes ==="
          du -sh ~/.local || true
          du -sh ~/.llvm-project || true

  # ============================================================================
  # Build and test CUDA-Q
  # ============================================================================
  build_and_test:
    name: Build (${{ matrix.arch }})
    needs: [metadata, devdeps]
    strategy:
      matrix:
        include:
          - runner: macos-15
            arch: arm64
            deployment_target: '11.0'
          # Uncomment to enable Intel x86_64
          # - runner: macos-15-intel
          #   arch: x86_64
          #   deployment_target: '10.13'
      fail-fast: false
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Restore prerequisites cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.local
            ~/.llvm-project
          key: macos-${{ matrix.arch }}-${{ matrix.deployment_target }}-devdeps-${{ needs.metadata.outputs.llvm_commit }}
          fail-on-cache-miss: true

      - name: Build CUDA-Q
        env:
          MACOSX_DEPLOYMENT_TARGET: ${{ matrix.deployment_target }}
        run: |
          bash scripts/build_cudaq.sh -v

      - name: Run tests
        run: bash scripts/run_tests.sh -v
