on:
  workflow_dispatch:
    inputs:
      image:
        type: string
        required: true
        description: The full name of the image, including tag.
      platforms:
        type: string
        required: false
        description: The platform(s) for which the image should be available. 
        default: linux/amd64,linux/arm64
  
name: Push to GHCR

jobs:
  push_image:
    name: Push image to GHCR
    runs-on: ubuntu-latest
    permissions:
      packages: write

    environment:
      name: ghcr-deployment
      url: ${{ vars.deployment_url }}

    steps:
      - name: Login to GitHub CR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Set up context for buildx
        run: |
          docker context create builder_context

      - name: Set up buildx runner
        uses: docker/setup-buildx-action@v2
        with:
          endpoint: builder_context

      - name: Prepare push
        id: metadata
        run: |
          repo_owner=${{ github.repository_owner }}
          image_tag=`echo ${{ inputs.image }} | sed -e 's@.*\.io/\(\)@\1@'`
          dockerfile=image.Dockerfile
          echo 'FROM ${{ inputs.image }}' > $dockerfile

          # No need to specify labels - they propagate automatically
          echo "dockerfile=$dockerfile" >> $GITHUB_OUTPUT
          echo "tags=${{ vars.registry }}/${repo_owner,,}/${image_tag#${repo_owner,,}}" >> $GITHUB_OUTPUT

      - name: Push image
        id: docker_build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ steps.metadata.outputs.dockerfile }}
          tags: ${{ steps.metadata.outputs.tags }}
          labels: ${{ steps.metadata.outputs.labels }}
          platforms: ${{ inputs.platforms }}
          push: true
