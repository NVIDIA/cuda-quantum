#INFO: **** input file is /home/cudaq/.local/lib/python3.10/site-packages/cudaq_solvers/bin/cudaq-pyscf ****
#!/usr/bin/env python3

import argparse
import importlib, pkgutil
import cudaq_solvers.tools.molecule.pyscf.generators

from fastapi import FastAPI, Response
from pydantic import BaseModel, PlainValidator, PlainSerializer
import uvicorn, os, signal, importlib, pkgutil
from typing import List, Annotated
import numpy as np


def iter_namespace(ns_pkg):
    return pkgutil.iter_modules(ns_pkg.__path__, ns_pkg.__name__ + ".")


discovered_plugins = {}
for finder, name, ispkg in iter_namespace(
        cudaq_solvers.tools.molecule.pyscf.generators):
    try:
        discovered_plugins[name] = importlib.import_module(name)
    except ModuleNotFoundError:
        pass

hamiltonianGenerators = {
    plugin.get_hamiltonian_generator().name(): plugin
    for _, plugin in discovered_plugins.items()
}

#############################
# Argument Parser
#############################

parser = argparse.ArgumentParser()

parser.add_argument('--server-mode', action='store_true', default=False)

# Add arguments
parser.add_argument(
    '--type',
    type=str,
    help='type of simulation (hamiltonian generator) - options include {}'.
    format([k for k, v in hamiltonianGenerators.items()]),
    default='gas_phase')
parser.add_argument('--xyz', help="xyz file", type=str)
parser.add_argument('--basis', help='', type=str)
parser.add_argument('--charge', help="charge of the system", type=int)
parser.add_argument('--out-file-name',
                    help='base file name for output data.',
                    type=str)
parser.add_argument('--spin',
                    help="no. of unpaired electrons (2 *s)",
                    type=int)
parser.add_argument('--symmetry', help="", action='store_true', default=False)
parser.add_argument('--memory', help="", type=float, default=4000)
parser.add_argument('--cycles', help="", type=int, default=100)
parser.add_argument('--initguess', help="", type=str, default='minao')
parser.add_argument('--UR', help="", action='store_true', default=False)
parser.add_argument('--MP2', help="", action='store_true', default=False)
parser.add_argument('--nele_cas', help="", type=int, default=None)
parser.add_argument('--norb_cas', help="", type=int, default=None)
parser.add_argument('--natorb', help="", action='store_true', default=False)
parser.add_argument('--casci', help="", action='store_true', default=False)
parser.add_argument('--ccsd', help="", action='store_true', default=False)
parser.add_argument('--casscf', help="", action='store_true', default=False)
parser.add_argument('--integrals_natorb',
                    help="",
                    action='store_true',
                    default=False)
parser.add_argument('--integrals_casscf',
                    help="",
                    action='store_true',
                    default=False)
parser.add_argument('--potfile', help="", type=str, default=None)
parser.add_argument('--verbose',
                    help="Verbose printout",
                    action='store_true',
                    default=False)

# Parse the arguments
args = parser.parse_args()

if not args.server_mode:

    if args.type not in hamiltonianGenerators:
        raise RuntimeError(f'invalid hamiltonian generator type - {args.type}')
    hamiltonianGenerator = hamiltonianGenerators[
        args.type].get_hamiltonian_generator()

    filterArgs = ['xyz', 'basis']
    filteredArgs = {
        k: v
        for (k, v) in vars(args).items() if k not in filterArgs
    }
    res = hamiltonianGenerator.generate(args.xyz, args.basis, **filteredArgs)
    print(res)

    exit(0)

app = FastAPI()


@app.get("/shutdown")
async def shutdown():
    os.kill(os.getpid(), signal.SIGTERM)
    return Response(status_code=200, content='Server shutting down...')


class IntegralsData(BaseModel):
    data: List[List]


class MoleculeInput(BaseModel):
    basis: str
    xyz: str
    spin: int
    charge: int
    type: str = 'gas_phase'
    symmetry: bool = False
    cycles: int = 100
    memory: float = 4000.
    initguess: str = 'minao'
    UR: bool = False
    MP2: bool = False
    natorb: bool = False
    casci: bool = False
    ccsd: bool = False
    casscf: bool = False
    integrals_natorb: bool = False
    integrals_casscf: bool = False
    verbose: bool = False
    nele_cas: int = None
    norb_cas: int = None
    potfile: str = None



class Molecule(BaseModel):
    energies: dict
    num_orbitals: int
    num_electrons: int
    hpq: IntegralsData
    hpqrs: IntegralsData


@app.get("/status")
async def get_status():
    return {"status" : "available"}

@app.post("/create_molecule")
async def create_molecule(molecule: MoleculeInput):
    hamiltonianGenerator = hamiltonianGenerators[
        molecule.type].get_hamiltonian_generator()

    filterArgs = ['xyz', 'basis']
    filteredArgs = {
        k: v
        for (k, v) in vars(molecule).items() if k not in filterArgs
    }
    filteredArgs['cache_data'] = False
    res = hamiltonianGenerator.generate(molecule.xyz, molecule.basis,
                                        **filteredArgs)
    return Molecule(energies=res['energies'],
                    num_orbitals=res['num_orbitals'],
                    num_electrons=res['num_electrons'],
                    hpq=IntegralsData(data=res['hpq']['data']),
                    hpqrs=IntegralsData(data=res['hpqrs']['data']))


if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000, log_level='critical')#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='gorby', release='5.4.0-195-generic', version='#215-Ubuntu SMP Fri Aug 2 18:28:05 UTC 2024', machine='x86_64')  Threads 128
Python 3.10.12 (main, Jan 17 2025, 14:35:34) [GCC 11.4.0]
numpy 1.26.4  scipy 1.12.0  h5py 3.12.1
Date: Mon Feb 10 20:18:10 2025
PySCF version 2.6.2
PySCF path  /home/cudaq/.local/lib/python3.10/site-packages/pyscf

[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 3
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 O      0.117300000000   0.000000000000   0.000000000000 AA    0.221664874411   0.000000000000   0.000000000000 Bohr   0.0
[INPUT]  2 H     -0.469100000000   0.757000000000   0.000000000000 AA   -0.886470525033   1.430522676296   0.000000000000 Bohr   0.0
[INPUT]  3 H     -0.469100000000  -0.757000000000   0.000000000000 AA   -0.886470525033  -1.430522676296   0.000000000000 Bohr   0.0

nuclear repulsion = 9.19165111857177
number of shells = 5
number of NR pGTOs = 21
number of NR cGTOs = 7
basis = sto-3g
ecp = {}
CPU time:        15.21


******** <class 'pyscf.scf.hf.RHF'> ********
method = RHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
diis_damp = 0
SCF conv_tol = 1e-09
SCF conv_tol_grad = None
SCF max_cycles = 100
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = O 0-pyscf.chk
max_memory 4000 MB (current use 124 MB)
Set gradient conv threshold to 3.16228e-05
Initial guess from minao.
init E= -74.8367651840778
  HOMO = -0.39318669569659  LUMO = 0.426670666551946
cycle= 1 E= -74.9128067382225  delta_E= -0.076  |g|= 0.37  |ddm|= 1.69
  HOMO = -0.267778861217974  LUMO = 0.644307637668772
cycle= 2 E= -74.9624642067631  delta_E= -0.0497  |g|= 0.0425  |ddm|= 0.56
  HOMO = -0.390842909270736  LUMO = 0.605168728587115
cycle= 3 E= -74.9629672954461  delta_E= -0.000503  |g|= 0.00833  |ddm|= 0.0433
  HOMO = -0.391259864920884  LUMO = 0.605476833848671
cycle= 4 E= -74.9629935280688  delta_E= -2.62e-05  |g|= 6.23e-05  |ddm|= 0.015
  HOMO = -0.39125203316731  LUMO = 0.605390386198235
cycle= 5 E= -74.9629935296333  delta_E= -1.56e-09  |g|= 1.39e-05  |ddm|= 9.8e-05
  HOMO = -0.391254010534432  LUMO = 0.605398054565096
cycle= 6 E= -74.9629935297764  delta_E= -1.43e-10  |g|= 3.41e-06  |ddm|= 4e-05
  HOMO = -0.391254902959831  LUMO = 0.605400203573901
Extra cycle  E= -74.9629935297838  delta_E= -7.42e-12  |g|= 1.45e-06  |ddm|= 7.35e-06
converged SCF energy = -74.9629935297838
