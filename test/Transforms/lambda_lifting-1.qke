// ========================================================================== //
// Copyright (c) 2025 NVIDIA Corporation & Affiliates.                        //
// All rights reserved.                                                       //
//                                                                            //
// This source code and the accompanying materials are made available under   //
// the terms of the Apache License 2.0 which accompanies this distribution.   //
// ========================================================================== //

// RUN: cudaq-opt --lambda-lifting=constant-prop=1 --canonicalize %s | FileCheck %s

func.func private @__nvqpp__mlirgen__foo..0x7abaa13ce580(%arg0: i64)

func.func @__nvqpp__mlirgen__bar..0x7aba206b5040() -> i64 {
  %c8_i64 = arith.constant 8 : i64
  %0 = cc.create_lambda {
  ^bb0(%arg0: i64):
    func.call @__nvqpp__mlirgen__foo..0x7abaa13ce580(%arg0) : (i64) -> ()
    %1 = arith.constant 1 : i32
    cc.return %1 : i32
  } : !cc.callable<(i64) -> i32>
  %1 = cc.call_callable %0, %c8_i64 : (!cc.callable<(i64) -> i32>, i64) -> i32
  %2 = cc.cast unsigned %1 : (i32) -> i64
  return %2 : i64
}

// CHECK-LABEL:   func.func @__nvqpp__mlirgen__bar..0x7aba206b5040() -> i64 {
// CHECK:           %[[VAL_0:.*]] = arith.constant 8 : i64
// CHECK:           %[[VAL_1:.*]] = cc.instantiate_callable @__nvqpp__callable.thunk.lambda.0() : () -> !cc.callable<(i64) -> i32>
// CHECK:           %[[VAL_2:.*]] = call @__nvqpp__callable.thunk.lambda.0(%[[VAL_1]], %[[VAL_0]]) : (!cc.callable<(i64) -> i32>, i64) -> i32
// CHECK:           %[[VAL_3:.*]] = cc.cast unsigned %[[VAL_2]] : (i32) -> i64
// CHECK:           return %[[VAL_3]] : i64
// CHECK:         }

// CHECK-LABEL:   func.func private @__nvqpp__callable.thunk.lambda.0(
// CHECK-SAME:      %[[VAL_0:.*]]: !cc.callable<(i64) -> i32>,
// CHECK-SAME:      %[[VAL_1:.*]]: i64) -> i32 attributes {"cudaq-kernel"} {
// CHECK:           %[[VAL_2:.*]] = call @__nvqpp__lifted.lambda.0(%[[VAL_1]]) : (i64) -> i32
// CHECK:           return %[[VAL_2]] : i32
// CHECK:         }

// CHECK-LABEL:   func.func private @__nvqpp__lifted.lambda.0(
// CHECK-SAME:      %[[VAL_0:.*]]: i64) -> i32 attributes {"cudaq-kernel"} {
// CHECK:           %[[VAL_1:.*]] = arith.constant 1 : i32
// CHECK:           call @__nvqpp__mlirgen__foo..0x7abaa13ce580(%[[VAL_0]]) : (i64) -> ()
// CHECK:           return %[[VAL_1]] : i32
// CHECK:         }
